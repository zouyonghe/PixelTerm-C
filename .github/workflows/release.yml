name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-linux:
    runs-on: ${{ matrix.runs-on }}
    container:
      image: ${{ matrix.container }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runs-on: ubuntu-latest
            container: archlinux:latest
          - arch: arm64
            runs-on: ubuntu-24.04-arm
            container: menci/archlinuxarm:base-devel
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build on Linux (Arch)
      run: |
        mkdir -p release-${{ matrix.arch }}
        
        # Native build for Linux (amd64/arm64)
        echo "Native build for ${{ matrix.arch }}"
        
        # Install dependencies
        pacman-key --init
        if pacman -Si archlinuxarm-keyring >/dev/null 2>&1; then
          pacman-key --populate archlinuxarm
          pacman -Syu --noconfirm --needed archlinuxarm-keyring
        else
          pacman-key --populate archlinux
          pacman -Syu --noconfirm --needed archlinux-keyring
        fi
        deps=(base-devel pkgconf git glib2 gdk-pixbuf2 chafa ffmpeg mupdf)
        if pacman -Si libmupdf >/dev/null 2>&1; then
          deps+=(libmupdf)
        fi
        pacman -Syu --noconfirm --needed "${deps[@]}"
        
        # Build PixelTerm-C
        make clean && make
        if command -v strip >/dev/null; then
          strip bin/pixelterm || true
        fi
        cp bin/pixelterm release-${{ matrix.arch }}/pixelterm-${{ matrix.arch }}-linux

    - name: Create release package
      run: |
        mkdir -p release
        cp release-${{ matrix.arch }}/pixelterm-${{ matrix.arch }}-linux release/
        tar -czf release/pixelterm-${{ matrix.arch }}-linux.tar.gz -C release pixelterm-${{ matrix.arch }}-linux

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pixelterm-${{ matrix.arch }}-linux.tar.gz
        path: release/pixelterm-${{ matrix.arch }}-linux.tar.gz

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: pixelterm-${{ matrix.arch }}-linux
        path: release/pixelterm-${{ matrix.arch }}-linux

  build-macos:
    runs-on: ${{ matrix.runs-on }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runs-on: macos-latest
          - arch: arm64
            runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build on macOS
      run: |
        mkdir -p release-${{ matrix.arch }}
        
        # Install dependencies using Homebrew (only install packages not pre-installed)
        brew install pkg-config glib gdk-pixbuf chafa ffmpeg mupdf
        export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:$(brew --prefix)/share/pkgconfig"
        
        # Chafa is already installed by Homebrew, no need to build from source
        echo "Using Homebrew Chafa"
        
        # Build PixelTerm-C
        make clean && make
        if command -v strip >/dev/null; then
          strip bin/pixelterm || true
        fi
        cp bin/pixelterm release-${{ matrix.arch }}/pixelterm-${{ matrix.arch }}-macos

    - name: Create release package
      run: |
        mkdir -p release
        cp release-${{ matrix.arch }}/pixelterm-${{ matrix.arch }}-macos release/
        tar -czf release/pixelterm-${{ matrix.arch }}-macos.tar.gz -C release pixelterm-${{ matrix.arch }}-macos

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pixelterm-${{ matrix.arch }}-macos.tar.gz
        path: release/pixelterm-${{ matrix.arch }}-macos.tar.gz

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: pixelterm-${{ matrix.arch }}-macos
        path: release/pixelterm-${{ matrix.arch }}-macos

  create-release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: pixelterm*
        merge-multiple: true

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          pixelterm-amd64-linux.tar.gz
          pixelterm-amd64-linux
          pixelterm-arm64-linux.tar.gz
          pixelterm-arm64-linux
          pixelterm-amd64-macos.tar.gz
          pixelterm-amd64-macos
          pixelterm-arm64-macos.tar.gz
          pixelterm-arm64-macos
